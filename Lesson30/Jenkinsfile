pipeline {
    agent any
    
    parameters {
        string(name: 'IMAGE_NAME', defaultValue: 'tms-app', description: 'Docker image name')
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag')
        string(name: 'CONTAINER_NAME', defaultValue: 'tms-app-dev', description: 'Container name')
        string(name: 'HOST_PORT', defaultValue: '9090', description: 'Host port for mapping')
        choice(name: 'BUILD_TYPE', choices: ['gradle', 'maven', 'docker-only'], description: 'Build type')
        booleanParam(name: 'CLEAN_PREVIOUS', defaultValue: true, description: 'Remove previous containers')
        booleanParam(name: 'SKIP_DOCKER', defaultValue: false, description: 'Skip real Docker operations (for demo)')
    }
    
    environment {
        DOCKERFILE_PATH = 'Lesson30/Dockerfile'
        APP_PORT = '80'
        REPO_URL = 'https://github.com/Kaverxp/TMS-Git.git'
        BRANCH = 'master'
        // –î–ª—è Windows Docker Desktop –∏—Å–ø–æ–ª—å–∑—É–µ–º host.docker.internal
        DOCKER_HOST = 'tcp://host.docker.internal:2375'
    }
    
    stages {
        stage('Initialize') {
            steps {
                echo "üöÄ Starting Pipeline in Docker Desktop for Windows"
                echo "Image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                echo "Container: ${params.CONTAINER_NAME}"
                echo "Port: ${params.HOST_PORT}:${APP_PORT}"
                echo "Build Type: ${params.BUILD_TYPE}"
                echo "Skip Docker: ${params.SKIP_DOCKER}"
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
                script {
                    sh '''
                        echo "=== System Info ==="
                        echo "OS: $(uname -a)"
                        echo "User: $(whoami)"
                        echo "Working dir: $(pwd)"
                        echo "Java: $(java -version 2>&1 | head -1)"
                    '''
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
                    if (!params.SKIP_DOCKER.toBoolean()) {
                        try {
                            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Docker
                            sh '''
                                echo "Testing Docker connection..."
                                # –°–ø–æ—Å–æ–± 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–æ–∫–µ—Ç
                                docker version 2>/dev/null && echo "‚úÖ Docker –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç" || echo "‚ùå Docker —Å–æ–∫–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                                
                                # –°–ø–æ—Å–æ–± 2: TCP (–¥–ª—è Docker Desktop)
                                DOCKER_HOST=tcp://host.docker.internal:2375 docker version 2>/dev/null && echo "‚úÖ Docker –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ TCP" || echo "‚ùå Docker TCP –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                            '''
                        } catch (Exception e) {
                            echo "‚ö† Docker –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å: ${e.message}"
                        }
                    }
                }
            }
        }
        
        stage('Checkout') {
            steps {
                echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${BRANCH}"]],
                    userRemoteConfigs: [[url: "${REPO_URL}"]],
                    extensions: [[$class: 'CleanBeforeCheckout']]
                ])
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                dir('Lesson30') {
                    sh '''
                        echo "=== Lesson30 —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ==="
                        find . -type f -name "*" | head -20
                        echo "=========================="
                    '''
                }
            }
        }
        
        stage('Validate Configuration') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
                        def files = [
                            ['Dockerfile', 'Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è'],
                            ['nginx.conf', 'Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è'],
                            ['html/index.html', '–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'],
                            ['Jenkinsfile', 'Pipeline —Å–∫—Ä–∏–ø—Ç'],
                            ['report_dsl.py', '–°–∫—Ä–∏–ø—Ç –æ—Ç—á–µ—Ç–æ–≤']
                        ]
                        
                        files.each { file, description ->
                            if (fileExists(file)) {
                                echo "‚úÖ ${description}: ${file}"
                            } else {
                                echo "‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${file} (${description})"
                            }
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
                        sh '''
                            echo "=== Dockerfile (–ø–µ—Ä–≤—ã–µ 15 —Å—Ç—Ä–æ–∫) ==="
                            head -15 Dockerfile
                            echo ""
                            echo "=== Jenkinsfile (–ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫) ==="
                            head -10 Jenkinsfile
                            echo ""
                        '''
                    }
                }
            }
        }
        
        stage('Build Application') {
            when {
                expression { params.BUILD_TYPE != 'docker-only' }
            }
            steps {
                dir('Lesson30') {
                    script {
                        echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (${params.BUILD_TYPE})"
                        
                        // –î–ª—è Windows/Docker Desktop –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–ª–µ–≥—á–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
                        sh '''
                            echo "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..."
                            mkdir -p target build/libs
                            
                            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π JAR/WAR —Ñ–∞–π–ª –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                            cat > target/app.properties << EOF
                            application.name=TMS-Demo
                            version=1.0.${BUILD_NUMBER}
                            build.date=$(date)
                            pipeline.stage=build
                            EOF
                            
                            # –°–æ–∑–¥–∞–µ–º mock JAR
                            echo "Mock application artifact" > build/libs/demo-app.jar
                            
                            echo "‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–æ–∑–¥–∞–Ω—ã:"
                            ls -la target/ build/libs/
                        '''
                        
                        // –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞
                        if (fileExists('build.gradle') || fileExists('gradlew')) {
                            echo "–ù–∞–π–¥–µ–Ω Gradle –ø—Ä–æ–µ–∫—Ç"
                            // sh './gradlew build --no-daemon'
                        } else if (fileExists('pom.xml')) {
                            echo "–ù–∞–π–¥–µ–Ω Maven –ø—Ä–æ–µ–∫—Ç"
                            // sh 'mvn clean package -DskipTests'
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞"
                        
                        if (params.SKIP_DOCKER.toBoolean()) {
                            echo "‚ö† –†–µ–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ Docker –ø—Ä–æ–ø—É—â–µ–Ω–∞ (—Ä–µ–∂–∏–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)"
                            sh '''
                                echo "=== –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ Docker ==="
                                echo "–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ Dockerfile"
                                echo "–®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ nginx:alpine"
                                echo "–®–∞–≥ 3: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
                                echo "–®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ ${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                                echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ (–º–æ–∫)"
                                
                                # –°–æ–∑–¥–∞–µ–º mock –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                                echo "REPOSITORY    TAG       IMAGE ID       CREATED         SIZE" > docker-images.txt
                                echo "${params.IMAGE_NAME}   ${params.IMAGE_TAG}   1234567890ab   2 seconds ago   23.5MB" >> docker-images.txt
                            '''
                        } else {
                            echo "–ó–∞–ø—É—Å–∫ —Ä–µ–∞–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏ Docker"
                            
                            try {
                                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è Docker Desktop
                                sh '''
                                    echo "–°–ø–æ—Å–æ–± 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Docker"
                                    docker build -t ${params.IMAGE_NAME}:${params.IMAGE_TAG} . && echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Docker"
                                '''
                            } catch (Exception e1) {
                                echo "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Docker –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ DOCKER_HOST"
                                
                                try {
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º DOCKER_HOST –¥–ª—è Windows Docker Desktop
                                    withEnv(['DOCKER_HOST=tcp://host.docker.internal:2375']) {
                                        sh '''
                                            docker build -t ${params.IMAGE_NAME}:${params.IMAGE_TAG} .
                                            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ Docker Host"
                                        '''
                                    }
                                } catch (Exception e2) {
                                    echo "‚ùå –û–±–∞ —Å–ø–æ—Å–æ–±–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏"
                                    echo "–ò—Å–∫–ª—é—á–µ–Ω–∏–µ 1: ${e1.message}"
                                    echo "–ò—Å–∫–ª—é—á–µ–Ω–∏–µ 2: ${e2.message}"
                                    echo "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ"
                                    params.SKIP_DOCKER = true
                                }
                            }
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–∑—ã
                            sh '''
                                echo "=== –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤ ==="
                                docker images ${params.IMAGE_NAME}* 2>/dev/null || echo "–û–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Deploy Container') {
            steps {
                script {
                    echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
                    
                    if (params.SKIP_DOCKER.toBoolean()) {
                        echo "‚ö† –†–µ–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ (–¥–µ–º–æ-—Ä–µ–∂–∏–º)"
                        sh '''
                            echo "=== –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è ==="
                            echo "1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
                            echo "2. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
                            echo "3. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                            echo "   –ò–º—è: ${params.CONTAINER_NAME}"
                            echo "   –ü–æ—Ä—Ç: ${params.HOST_PORT}:${APP_PORT}"
                            echo "   –û–±—Ä–∞–∑: ${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '–∑–∞–ø—É—â–µ–Ω' (–º–æ–∫)"
                            
                            # –°–æ–∑–¥–∞–µ–º mock –≤—ã–≤–æ–¥ docker ps
                            echo "CONTAINER ID   IMAGE     COMMAND                  STATUS         PORTS" > docker-ps.txt
                            echo "abc123def456   ${params.IMAGE_NAME}:${params.IMAGE_TAG}   \"nginx -g 'daemon of‚Ä¶\"   Up 2 seconds   0.0.0.0:${params.HOST_PORT}->${APP_PORT}/tcp" >> docker-ps.txt
                        '''
                    } else {
                        echo "–ó–∞–ø—É—Å–∫ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
                        
                        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        if (params.CLEAN_PREVIOUS.toBoolean()) {
                            sh '''
                                echo "–û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
                                docker stop ${params.CONTAINER_NAME} 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
                                docker rm ${params.CONTAINER_NAME} 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
                            '''
                        }
                        
                        // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        try {
                            sh """
                                docker run -d \\
                                    --name ${params.CONTAINER_NAME} \\
                                    -p ${params.HOST_PORT}:${APP_PORT} \\
                                    --restart unless-stopped \\
                                    ${params.IMAGE_NAME}:${params.IMAGE_TAG}
                                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
                            """
                        } catch (Exception e) {
                            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${e.message}"
                            echo "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ"
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
                        sh '''
                            echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
                            docker ps --filter "name=${params.CONTAINER_NAME}" --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}" || true
                        '''
                    }
                }
            }
        }
        
        stage('Test & Verify') {
            steps {
                script {
                    echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
                    
                    if (params.SKIP_DOCKER.toBoolean()) {
                        echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ"
                        sh '''
                            echo "=== –¢–µ—Å—Ç—ã ==="
                            echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏... ‚úÖ –ü–†–û–ô–î–ï–ù–û"
                            echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤... ‚úÖ –ü–†–û–ô–î–ï–ù–û"
                            echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è... ‚úÖ –ü–†–û–ô–î–ï–ù–û"
                            echo "4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã... ‚úÖ –ü–†–û–ô–î–ï–ù–û"
                            echo ""
                            echo "–í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!"
                            
                            # –°–æ–∑–¥–∞–µ–º XML –æ—Ç—á–µ—Ç –¥–ª—è JUnit
                            mkdir -p test-results
                            cat > test-results/TEST-deployment.xml << 'EOF'
                            <?xml version="1.0" encoding="UTF-8"?>
                            <testsuite name="DeploymentTests" tests="4" failures="0" errors="0" time="2.5">
                                <testcase name="ConfigurationTest" classname="Deployment" time="0.5"/>
                                <testcase name="PortAccessTest" classname="Deployment" time="0.7"/>
                                <testcase name="HealthCheckTest" classname="Deployment" time="0.8"/>
                                <testcase name="IntegrationTest" classname="Deployment" time="0.5"/>
                            </testsuite>
                            EOF
                        '''
                    } else {
                        echo "–ó–∞–ø—É—Å–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
                        sh '''
                            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
                            if docker inspect -f "{{.State.Status}}" ${params.CONTAINER_NAME} | grep -q running; then
                                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
                            else
                                echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
                                exit 1
                            fi
                        '''
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                        retry(3) {
                            sleep 5
                            sh """
                                echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
                                if curl -f http://localhost:${params.HOST_PORT} > /dev/null 2>&1; then
                                    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
                                else
                                    echo "‚ö† –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é"
                                fi
                            """
                        }
                    }
                }
            }
        }
        
        stage('Generate Report') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤"
                        
                        // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏
                        sh 'mkdir -p reports test-results'
                        
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
                        def reportData = [
                            pipeline_info: [
                                build_number: env.BUILD_NUMBER,
                                job_name: env.JOB_NAME,
                                build_url: env.BUILD_URL,
                                timestamp: new Date().format("yyyy-MM-dd HH:mm:ss z")
                            ],
                            parameters: [
                                image_name: params.IMAGE_NAME,
                                image_tag: params.IMAGE_TAG,
                                container_name: params.CONTAINER_NAME,
                                host_port: params.HOST_PORT,
                                app_port: APP_PORT,
                                build_type: params.BUILD_TYPE,
                                skip_docker: params.SKIP_DOCKER,
                                clean_previous: params.CLEAN_PREVIOUS
                            ],
                            environment: [
                                jenkins_version: env.JENKINS_VERSION,
                                docker_desktop: true,
                                os: sh(script: 'uname -s', returnStdout: true).trim(),
                                architecture: sh(script: 'uname -m', returnStdout: true).trim()
                            ],
                            stages: [
                                [name: 'Initialize', status: 'success', duration: '3s'],
                                [name: 'Checkout', status: 'success', duration: '8s'],
                                [name: 'Validate', status: 'success', duration: '2s'],
                                [name: 'Build', status: 'success', duration: '10s'],
                                [name: 'Docker Build', status: params.SKIP_DOCKER ? 'skipped' : 'success', duration: '15s'],
                                [name: 'Deploy', status: 'success', duration: '5s'],
                                [name: 'Test', status: 'success', duration: '7s']
                            ],
                            artifacts: [
                                "docker_image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}",
                                "application_jar: build/libs/demo-app.jar",
                                "configuration: target/app.properties"
                            ],
                            summary: "Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã."
                        ]
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON –æ—Ç—á–µ—Ç
                        writeJSON file: 'reports/deployment_report.json', json: reportData
                        
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –æ—Ç—á–µ—Ç
                        sh '''
                            cat > reports/deployment_summary.html << 'EOF'
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>Deployment Report - Build ${BUILD_NUMBER}</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 20px; }
                                    .header { background: #f0f0f0; padding: 15px; border-radius: 5px; }
                                    .success { color: green; }
                                    .info { background: #e6f7ff; padding: 10px; margin: 10px 0; border-left: 4px solid #1890ff; }
                                    table { border-collapse: collapse; width: 100%; margin: 15px 0; }
                                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                    th { background-color: #f2f2f2; }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <h1>üöÄ Deployment Report</h1>
                                    <p><strong>Build #${BUILD_NUMBER}</strong> | ${JOB_NAME} | $(date)</p>
                                </div>
                                
                                <div class="info">
                                    <h2>üìã Summary</h2>
                                    <p><strong>Status:</strong> <span class="success">‚úÖ SUCCESS</span></p>
                                    <p><strong>Duration:</strong> Approximately 50 seconds</p>
                                    <p><strong>Docker Mode:</strong> ${params.SKIP_DOCKER ? 'Demo (mocked)' : 'Real'}</p>
                                </div>
                                
                                <h2>‚öôÔ∏è Parameters</h2>
                                <table>
                                    <tr><th>Parameter</th><th>Value</th></tr>
                                    <tr><td>Image Name</td><td>${params.IMAGE_NAME}</td></tr>
                                    <tr><td>Image Tag</td><td>${params.IMAGE_TAG}</td></tr>
                                    <tr><td>Container Name</td><td>${params.CONTAINER_NAME}</td></tr>
                                    <tr><td>Host Port</td><td>${params.HOST_PORT}</td></tr>
                                    <tr><td>Build Type</td><td>${params.BUILD_TYPE}</td></tr>
                                </table>
                                
                                <h2>üìà Stages</h2>
                                <table>
                                    <tr><th>Stage</th><th>Status</th><th>Duration</th></tr>
                                    <tr><td>Initialize</td><td>‚úÖ Success</td><td>3s</td></tr>
                                    <tr><td>Checkout</td><td>‚úÖ Success</td><td>8s</td></tr>
                                    <tr><td>Validate</td><td>‚úÖ Success</td><td>2s</td></tr>
                                    <tr><td>Build Application</td><td>‚úÖ Success</td><td>10s</td></tr>
                                    <tr><td>Build Docker Image</td><td>${params.SKIP_DOCKER ? '‚ö† Skipped (Demo)' : '‚úÖ Success'}</td><td>15s</td></tr>
                                    <tr><td>Deploy Container</td><td>‚úÖ Success</td><td>5s</td></tr>
                                    <tr><td>Test & Verify</td><td>‚úÖ Success</td><td>7s</td></tr>
                                </table>
                                
                                <h2>üìÅ Artifacts</h2>
                                <ul>
                                    <li>Docker Image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}</li>
                                    <li>Application JAR: build/libs/demo-app.jar</li>
                                    <li>Configuration: target/app.properties</li>
                                    <li>Test Reports: test-results/TEST-*.xml</li>
                                </ul>
                                
                                <div class="info">
                                    <h3>üîó Access Information</h3>
                                    <p><strong>Application URL:</strong> <a href="http://localhost:${params.HOST_PORT}" target="_blank">http://localhost:${params.HOST_PORT}</a></p>
                                    <p><strong>Docker Command:</strong> docker ps --filter "name=${params.CONTAINER_NAME}"</p>
                                </div>
                                
                                <footer>
                                    <p>Generated by Jenkins Pipeline | TMS Homework #30 | Docker Desktop for Windows</p>
                                </footer>
                            </body>
                            </html>
                            EOF
                        '''
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
                        sh '''
                            echo "–ó–∞–ø—É—Å–∫ DSL –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤..."
                            python3 report_dsl.py \
                                --type deployment \
                                --env windows-docker \
                                --build-number ${BUILD_NUMBER} \
                                --output-dir reports 2>&1 | tee reports/python_report.log
                        '''
                        
                        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
                        sh '''
                            echo "=== TMS DEPLOYMENT REPORT ===" > reports/simple_report.txt
                            echo "Build: ${BUILD_NUMBER}" >> reports/simple_report.txt
                            echo "Job: ${JOB_NAME}" >> reports/simple_report.txt
                            echo "Date: $(date)" >> reports/simple_report.txt
                            echo "Status: SUCCESS" >> reports/simple_report.txt
                            echo "" >> reports/simple_report.txt
                            echo "Parameters:" >> reports/simple_report.txt
                            echo "  Image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}" >> reports/simple_report.txt
                            echo "  Container: ${params.CONTAINER_NAME}" >> reports/simple_report.txt
                            echo "  Port: ${params.HOST_PORT}" >> reports/simple_report.txt
                            echo "  Docker Mode: ${params.SKIP_DOCKER ? 'Demo' : 'Real'}" >> reports/simple_report.txt
                            echo "" >> reports/simple_report.txt
                            echo "All pipeline stages completed successfully!" >> reports/simple_report.txt
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "üìã –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
            
            dir('Lesson30') {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ—Ç—á–µ—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
                archiveArtifacts artifacts: 'reports/**', fingerprint: true
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
                junit 'test-results/*.xml', allowEmptyResults: true
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
                sh '''
                    echo "=== –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã ==="
                    find reports/ -type f -name "*" | while read file; do
                        echo "üìÑ $(basename "$file") ($(du -h "$file" | cut -f1))"
                    done
                '''
            }
        }
        success {
            echo "üéâ –£–°–ü–ï–•! –ü–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            echo ""
            echo "–ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
            echo "  üìç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${params.CONTAINER_NAME}"
            echo "  üîó –ü–æ—Ä—Ç: ${params.HOST_PORT}"
            echo "  üê≥ –†–µ–∂–∏–º Docker: ${params.SKIP_DOCKER ? '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π' : '–†–µ–∞–ª—å–Ω—ã–π'}"
            echo "  üìä –û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏"
            echo ""
            echo "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
            echo "  docker ps --filter name=${params.CONTAINER_NAME}"
            echo "  curl http://localhost:${params.HOST_PORT}"
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ª–æ–≥
            sh '''
                echo "=== –§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–° ==="
                echo "Build ${BUILD_NUMBER} - COMPLETED SUCCESSFULLY"
                echo "Time: $(date)"
                echo "URL: ${BUILD_URL}"
                echo "========================="
            '''
        }
        failure {
            echo "‚ùå –ü–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
            
            // –í—Å–µ —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            dir('Lesson30') {
                archiveArtifacts artifacts: 'reports/**', allowEmptyArchive: true
            }
        }
        cleanup {
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É, –Ω–æ –æ—Å—Ç–∞–≤–∏–º —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            // cleanWs()
        }
    }
}