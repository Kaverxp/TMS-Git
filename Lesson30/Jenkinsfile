pipeline {
    agent any
    
    parameters {
        string(name: 'IMAGE_NAME', defaultValue: 'tms-app', description: 'Docker image name')
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag')
        string(name: 'CONTAINER_NAME', defaultValue: 'tms-app-dev', description: 'Container name')
        string(name: 'HOST_PORT', defaultValue: '9090', description: 'Host port for mapping')
        choice(name: 'BUILD_TYPE', choices: ['gradle', 'maven', 'docker-only'], description: 'Build type')
        booleanParam(name: 'CLEAN_PREVIOUS', defaultValue: true, description: 'Remove previous containers')
    }
    
    environment {
        DOCKERFILE_PATH = 'Lesson30/Dockerfile'
        APP_PORT = '80'
        REPO_URL = 'https://github.com/Kaverxp/TMS-Git.git'
        BRANCH = 'master'
    }
    
    stages {
        stage('Initialize & Checkout') {
            steps {
                echo "üöÄ Starting Pipeline with parameters:"
                echo "Image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                echo "Container: ${params.CONTAINER_NAME}"
                echo "Port: ${params.HOST_PORT}:${APP_PORT}"
                
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${BRANCH}"]],
                    userRemoteConfigs: [[url: "${REPO_URL}"]]
                ])
            }
        }
        
        stage('Validate Dockerfile') {
            steps {
                dir('Lesson30') {
                    script {
                        if (!fileExists('Dockerfile')) {
                            error("‚ùå Dockerfile not found in repository! Please add Dockerfile to Lesson30/")
                        }
                        echo "‚úÖ Dockerfile found and validated"
                        sh '''
                            echo "=== Dockerfile content ==="
                            cat Dockerfile
                            echo "=========================="
                        '''
                    }
                }
            }
        }
        
        stage('Build Application') {
            when {
                expression { params.BUILD_TYPE != 'docker-only' }
            }
            steps {
                dir('Lesson30') {
                    script {
                        def buildCmd = (params.BUILD_TYPE == 'gradle') ? 'gradle build' : 'mvn clean package'
                        try {
                            sh "${buildCmd}"
                            echo "‚úÖ Application built successfully"
                        } catch (Exception e) {
                            echo "‚ö† Build failed, continuing with existing artifacts"
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "Building Docker image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                        sh """
                            docker build \
                                -t ${params.IMAGE_NAME}:${params.IMAGE_TAG} \
                                -t ${params.IMAGE_NAME}:build-${env.BUILD_NUMBER} \
                                .
                        """
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω
                        sh """
                            echo "=== Created images ==="
                            docker images | grep ${params.IMAGE_NAME}
                        """
                    }
                }
            }
        }
        
        stage('Deploy Container') {
            steps {
                script {
                    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
                    if (params.CLEAN_PREVIOUS.toBoolean()) {
                        echo "üßπ Cleaning previous containers..."
                        sh """
                            docker stop ${params.CONTAINER_NAME} 2>/dev/null || echo "No running container found"
                            docker rm ${params.CONTAINER_NAME} 2>/dev/null || echo "No container to remove"
                        """
                    }
                    
                    // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    echo "üöÄ Deploying new container..."
                    sh """
                        docker run -d \
                            --name ${params.CONTAINER_NAME} \
                            -p ${params.HOST_PORT}:${APP_PORT} \
                            --restart unless-stopped \
                            ${params.IMAGE_NAME}:${params.IMAGE_TAG}
                    """
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞
                    sleep 5
                    sh """
                        echo "=== Container status ==="
                        docker ps -a --filter "name=${params.CONTAINER_NAME}" \
                            --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                    """
                }
            }
        }
        
        stage('Test & Verify') {
            steps {
                script {
                    echo "üîç Testing deployed application..."
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
                    sh """
                        if docker inspect -f '{{.State.Running}}' ${params.CONTAINER_NAME} | grep -q true; then
                            echo "‚úÖ Container is running"
                        else
                            echo "‚ùå Container is not running!"
                            exit 1
                        fi
                    """
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    retry(3) {
                        sleep 3
                        sh """
                            echo "Testing HTTP connection..."
                            HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${params.HOST_PORT} || echo "000")
                            
                            if [ "\$HTTP_CODE" = "200" ] || [ "\$HTTP_CODE" = "302" ] || [ "\$HTTP_CODE" = "301" ]; then
                                echo "‚úÖ Application is accessible (HTTP: \$HTTP_CODE)"
                            else
                                echo "‚ö† Application responded with HTTP: \$HTTP_CODE"
                                # –ù–µ –ø–∞–¥–∞–µ–º, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª–µ–π
                            fi
                        """
                    }
                }
            }
        }
        
        stage('Generate Report') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "üìä Generating deployment report..."
                        
                        // –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç –≤ JSON
                        def report = [
                            pipeline: [
                                buildNumber: env.BUILD_NUMBER,
                                jobName: env.JOB_NAME,
                                timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ssZ")
                            ],
                            parameters: [
                                imageName: params.IMAGE_NAME,
                                imageTag: params.IMAGE_TAG,
                                containerName: params.CONTAINER_NAME,
                                port: params.HOST_PORT,
                                buildType: params.BUILD_TYPE
                            ],
                            status: [
                                containerRunning: sh(
                                    script: "docker inspect -f '{{.State.Running}}' ${params.CONTAINER_NAME}",
                                    returnStdout: true
                                ).trim(),
                                imageSize: sh(
                                    script: "docker images ${params.IMAGE_NAME}:${params.IMAGE_TAG} --format '{{.Size}}'",
                                    returnStdout: true
                                ).trim()
                            ],
                            artifacts: [
                                dockerImages: sh(
                                    script: "docker images --filter 'reference=${params.IMAGE_NAME}*' --format '{{.Repository}}:{{.Tag}}'",
                                    returnStdout: true
                                ).trim().split('\n')
                            ]
                        ]
                        
                        writeJSON file: 'reports/deployment_report.json', json: report
                        
                        // –¢–∞–∫–∂–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
                        sh '''
                            echo "=== DEPLOYMENT REPORT ===" > reports/summary.txt
                            date >> reports/summary.txt
                            echo "========================" >> reports/summary.txt
                            docker ps --filter "name=${params.CONTAINER_NAME}" >> reports/summary.txt
                            echo "" >> reports/summary.txt
                            echo "Docker images:" >> reports/summary.txt
                            docker images | grep ${params.IMAGE_NAME} >> reports/summary.txt
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "üìã Pipeline execution completed"
            dir('Lesson30') {
                archiveArtifacts artifacts: 'reports/**', fingerprint: true
                junit 'reports/*.xml'  // –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
            }
        }
        success {
            echo "üéâ SUCCESS! Application deployed to:"
            echo "   Container: ${params.CONTAINER_NAME}"
            echo "   URL: http://localhost:${params.HOST_PORT}"
            echo "   Image: ${params.IMAGE_NAME}:${params.IMAGE_TAG}"
            
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            // emailext subject: "SUCCESS: ${env.JOB_NAME}",
            //           body: "Deployment completed successfully",
            //           to: 'user@example.com'
        }
        failure {
            echo "‚ùå Pipeline failed!"
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
            sh """
                docker stop ${params.CONTAINER_NAME} 2>/dev/null || true
                docker rm ${params.CONTAINER_NAME} 2>/dev/null || true
            """
        }
        cleanup {
            // –û—á–∏—Å—Ç–∫–∞ workspace
            cleanWs()
        }
    }
}