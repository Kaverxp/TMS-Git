pipeline {
    agent any
    
    stages {
        stage('Initialize') {
            steps {
                echo "–ó–∞–ø—É—Å–∫ Pipeline"
                sh 'ls -la'
            }
        }
        
        stage('Checkout') {
            steps {
                git url: 'https://github.com/Kaverxp/TMS-Git.git', branch: 'master'
            }
        }
        
        stage('Build') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤"
                        if (fileExists('deploy.groovy')) {
                            echo "‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω"
                        }
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                dir('Lesson30') {
                    sh '''
                        echo "üß™ –¢–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã"
                        echo "–§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ:"
                        ls -la
                    '''
                }
            }
        }
        
        stage('Report') {
            steps {
                dir('Lesson30') {
                    sh '''
                        echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞..."
                        mkdir -p reports
                        python3 report_dsl.py --type pipeline --output-dir reports
                        echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
                    '''
                }
            }
        }
        
        stage('Deploy') {
            steps {
                dir('Lesson30') {
                    script {
                        echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è..."
                        // –ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç, –æ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        load 'deploy.groovy'
                    }
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
                sh '''
                    echo "–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
                    docker ps --filter "name=app-dev" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                    echo ""
                    echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
                '''
            }
        }
    }
    
    post {
        always {
            echo "üìã –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
            dir('Lesson30') {
                archiveArtifacts artifacts: 'reports/**'
                sh 'echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:" && ls -la reports/'
            }
        }
        success {
            echo "üéâ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û!"
            echo "Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9090"
        }
        failure {
            echo "‚ùå –û–®–ò–ë–ö–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø"
        }
    }
}