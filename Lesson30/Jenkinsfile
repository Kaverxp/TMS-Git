pipeline {
    agent any
    
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'test', 'prod'], description: '–û–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–ø–ª–æ—è')
        string(name: 'IMAGE_TAG', defaultValue: 'v1.0', description: '–¢–µ–≥ Docker-–æ–±—Ä–∞–∑–∞')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: '–ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã?')
        booleanParam(name: 'GENERATE_REPORT', defaultValue: true, description: '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç?')
    }
    
    environment {
        APP_NAME = 'tms-app'
        PROJECT_DIR = 'Lesson30'
        CONTAINER_NAME = "${APP_NAME}-${params.ENVIRONMENT}-lesson30"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Initialize') {
            steps {
                echo "üöÄ –ó–∞–ø—É—Å–∫ Pipeline #${BUILD_NUMBER}"
                echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${env.WORKSPACE}"
                sh 'find . -maxdepth 2 -type f \\( -name "*.groovy" -o -name "*.py" -o -name "Jenkinsfile" \\) | sort'
            }
        }
        
        stage('Checkout') {
            steps {
                echo "üì¶ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
                git url: 'https://github.com/Kaverxp/TMS-Git.git', branch: 'master'
                dir(env.PROJECT_DIR) {
                    sh 'ls -la && find . -type f \\( -name "*.groovy" -o -name "*.py" \\) | sort'
                }
            }
        }
        
        stage('Build') {
            when { expression { params.ENVIRONMENT != 'prod' } }
            steps {
                echo "üî® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏..."
                dir(env.PROJECT_DIR) {
                    script {
                        ['deploy.groovy', 'report_dsl.py'].each { file ->
                            if (fileExists(file)) {
                                echo "‚úÖ –ù–∞–π–¥–µ–Ω ${file}"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Test') {
            when { 
                allOf { 
                    expression { params.RUN_TESTS == true }
                    expression { params.ENVIRONMENT != 'prod' }
                } 
            }
            steps {
                echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
                dir(env.PROJECT_DIR) {
                    sh '''
                        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Groovy:"
                        head -5 deploy.groovy | grep -q "def" && echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
                        
                        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Python:"
                        python3 -m py_compile report_dsl.py && echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
                    '''
                }
            }
        }
        
        stage('Generate Report') {
            when { 
                allOf { 
                    expression { params.GENERATE_REPORT == true }
                    expression { fileExists("${env.PROJECT_DIR}/report_dsl.py") }
                } 
            }
            steps {
                echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞..."
                dir(env.PROJECT_DIR) {
                    sh '''
                        mkdir -p generated_reports
                        python3 report_dsl.py \
                            --type jenkins_pipeline \
                            --period $(date +%Y-%m) \
                            --format html \
                            --output-dir ./generated_reports \
                            --filter environment=''' + "${params.ENVIRONMENT}" + ''' \
                            --filter pipeline=lesson30 \
                            --filter build_number=''' + "${BUILD_NUMBER}"
                    '''
                }
            }
            post {
                success {
                    dir(env.PROJECT_DIR) {
                        archiveArtifacts artifacts: 'generated_reports/**'
                        publishHTML(target: [
                            reportDir: "generated_reports",
                            reportFiles: '*.html',
                            reportName: 'Lesson 30 Report'
                        ])
                    }
                }
            }
        }
        
        stage('Deploy') {
            when { expression { params.ENVIRONMENT in ['dev', 'test', 'prod'] } }
            steps {
                echo "üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è..."
                dir(env.PROJECT_DIR) {
                    script {
                        def deploy = load 'deploy.groovy'
                        deploy.call([
                            imageName: env.APP_NAME,
                            imageTag: params.IMAGE_TAG,
                            containerName: env.CONTAINER_NAME,
                            port: 9090,
                            environment: params.ENVIRONMENT
                        ])
                    }
                }
            }
        }
        
        stage('Verify') {
            when { expression { params.ENVIRONMENT in ['dev', 'test'] } }
            steps {
                echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è..."
                retry(3) {
                    sleep 3
                    sh """
                        echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
                        docker ps --filter "name=${env.CONTAINER_NAME}" --format "table {{.Names}}\\t{{.Status}}"
                        
                        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
                        docker inspect -f '{{.State.Status}}' ${env.CONTAINER_NAME}
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo "üìã –ò–¢–û–ì–ò: ${currentBuild.result}"
            echo "–°–±–æ—Ä–∫–∞: #${BUILD_NUMBER}"
            echo "–û–∫—Ä—É–∂–µ–Ω–∏–µ: ${params.ENVIRONMENT}"
            echo "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${currentBuild.durationString}"
            
            // –û—á–∏—Å—Ç–∫–∞ –¥–ª—è dev/test –æ–∫—Ä—É–∂–µ–Ω–∏–π
            script {
                if (params.ENVIRONMENT in ['dev', 'test']) {
                    sh '''
                        docker ps -a --filter "name=.*lesson30" -q | xargs -r docker stop 2>/dev/null || true
                        docker ps -a --filter "name=.*lesson30" -q | xargs -r docker rm 2>/dev/null || true
                    '''
                }
            }
        }
        success {
            echo "üéâ –£–°–ü–ï–®–ù–û!"
        }
        failure {
            echo "‚ùå –û–®–ò–ë–ö–ê!"
        }
    }
}